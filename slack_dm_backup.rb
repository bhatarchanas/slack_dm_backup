require 'trollop'

#USAGE: ruby slack_dm_backup.rb -t token_from_slack -o output_dir

##### Input 
opts = Trollop::options do
	opt :token, "Token generated by slack. Want a token? Go here: https://api.slack.com/custom-integrations/legacy-tokens", :type => :string, :short => "-t"
	opt :outfolder, "Output FASTQ file which has all the reads in it.", :type => :string, :short => "-o"
end 

##### Assigning variables to the input and making sure we got all the inputs
opts[:token].nil?      ==false  ? slack_token   = opts[:token]      : abort("Must supply a token provoded by slack with '-t'! Want a token? Go here: https://api.slack.com/custom-integrations/legacy-tokens")
opts[:outfolder].nil?  ==false  ? output_folder = opts[:outfolder]  : abort("Must supply an output folder name which will contain the json files for each users chat with you, use '-o' argument.")

##### Getting all the users in a separate file
`wget https://slack.com/api/users.list?token=#{slack_token} -O "users.list.json"`
`cat users.list.json | tr , '\n' | grep -Po '"name":".*"' | sed 's/.*\":\"//g' | sed 's/"//g' > users_list.txt`

##### Making the directory which will hold the json files
if File.directory?(output_folder)
	`rm -rf output_folder`
	`mkdir #{output_folder}`
else
	`mkdir #{output_folder}`
end

##### Creating an array with all the users
users_list_file = File.open("users_list.txt")

user_list = []
users_list_file.each do |line|
	user = line.chomp
	user_list.push(user)
end

##### Looping thorugh the array to generate json files for each user
user_list.each do |each_user|
	puts each_user.inspect
	`slack-history-export --token #{slack_token} --username #{each_user} --filepath #{each_user}.json`
	`mv #{each_user}.json #{output_folder}`
	sleep(10)
end
`mv users.list.json users_list.txt #{output_folder}`

